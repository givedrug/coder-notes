# 多线程中线程数的确定方式


在并发编程领域，提升性能本质上就是提升硬件的利用率，再具体点来说，就是提升I/O的利用率和CPU的利用率。

线程数的确定方式，取决于程序是IO密集型还是CPU密集型。

线程数并非越多越好，线程数过多将增加线程切换到时间，导致整体性能的下降。

## CPU密集型

对于CPU密集型计算，本质就是提升多核CPU的利用率，所以对于CPU密集型的计算场景，理论上 `最佳线程数=CPU核数` 就是最合适的。

不过在工程上，线程的数量一般会设置为 `CPU核数+1`，这样的话，当线程因为偶尔的内存页失效或其他原因导致阻塞时，这个额外的线程可以顶上。

> 这里的CPU核心数是物理核心数还是逻辑核心数呢？
> 
> CPU：独立的中央处理单元，体现在主板上是有多个CPU的槽位。
> 
> CPUcores：在每一个CPU上，都可能有多个核（core），每一个核中都有独立的一套ALU、FPU、Cache等组件，所以这个概念也被称作物理核。
> 
> processor：这个主要得益于超线程技术，可以让一个物理核模拟出多个逻辑核，即processor。
> 
> 简单来说就是，当有多个计算任务时，可以让其中一个计算任务使用ALU的时候，另一个则去使用FPU。
> 
> 这样就可以充分利用物理核中的各个部件，使得同一个物理核中，也可以并行处理多个计算任务。
> 
> ALU和FPU：工程师一般认为ALU是处理整数型（比如补码和BCD码）算术运算的的电路，而对更为复杂的格式（比如浮点型、复数型）进行计算的电路则拥有一个更加匹配的称谓。

所以对于可以让超线程技术充分发挥的程序，可以让线程数向逻辑核心数靠拢，否则向物理核心数靠拢，同时需要考虑到线程切换的时间成本。有人做过实验，当选择“物理核心数<=线程数<=逻辑核心数”，都是可行的，没有明显的差异，所以具体的数字需要实际测试决定。

## IO密集型

对于IO密集型计算，本质就是将所有IO等待时间，都用于CPU计算，所以，`最佳线程数=CPU核数*[1/CPU比例]` 或者 `CPU核数*[1+(I/O比例/CPU比例)]`。

如果没有办法准确的估计IO和CPU所占比例，那么可以使用经验公式`最佳线程数=(1.5~2)*CPU核数`。
