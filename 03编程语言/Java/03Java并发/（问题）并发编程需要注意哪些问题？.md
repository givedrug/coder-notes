# （问题）并发编程需要注意哪些问题？


## 安全性问题

所谓安全性问题，就是指有没有按照预期执行。需要规避可见性、原子性、有序性上的问题。

并发的对共享数据进行读写操作时，就需要考虑安全性问题。

数据竞争：当多个线程同时访问同一数据，并且至少有一个线程会写这个数据的时候。

竞态条件：程序的执行结果依赖线程执行的顺序。

常见的竞态条件类型：

- 先检查后执行
- 读取-写入-修改

解决方案：互斥锁。

## 活跃性问题

死锁：指两个或两个以上的进程（或线程）在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。

解决方案：破坏死锁的形成条件。

活锁：指线程1可以使用资源，但它很礼貌，让其他线程先使用资源，线程2也可以使用资源，但它很绅士，也让其他线程先使用资源。这样你让我，我让你，最后两个线程都无法使用资源。

解决方案：尝试等待一个随机的时间。

饥饿：指的是线程因无法访问所需资源而无法执行下去的情况。

解决方案：有三种方案，一是保证资源充足，二是公平地分配资源，三就是避免持有锁的线程长时间执行。其中方案二的适用场景相对来说更多一些，如使用公平锁。

## 性能问题

如果锁使用过度，导致串行范围过大，则无法发挥多线程的优势，将产生性能问题。

解决方案：

一，使用无锁算法和数据结构：例如线程本地存储（ThreadLocalStorage、TLS）、写入时复制（Copy-on-write）、乐观锁等；Java 并发包里面的原子类也是一种无锁的数据结构；Disruptor 则是一个无锁的内存队列，性能都非常好。

二，减少锁持有的时间：例如使用细粒度的锁，一个典型的例子就是 Java 并发包里的 ConcurrentHashMap，它使用了所谓分段锁的技术；还可以使用读写锁，也就是读是无锁的，只有写的时候才会互斥。

## 编写并发程序的一些建议

1.优先使用成熟的工具类：JavaSDK并发包里提供了丰富的工具类，基本上能满足你日常需要。

2.迫不得已时才使用低级的同步原语：低级的同步原语主要指的是 synchronized、Lock、Semaphore 等，这些虽然感觉简单，但实际上并没那么简单，一定要小心使用。

3.避免过早优化：安全第一，并发程序首先要保证安全，出现性能瓶颈后再优化。
